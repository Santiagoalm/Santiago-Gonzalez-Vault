#### Se pide agregar descripción y nombre de proveedor al reporte de XXALMEX_SEG_ACCION. 

![[Pasted image 20250611100204.png]]

``` SQL
SELECT DISTINCT
    G1.NUM_OC_1
    --,G1.PROVEEDORES
    --,G1.FECHA_CREACION
    ,(ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) AS ROWN
    ,DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) ,1 ,G1.PROVEEDORES, NULL) APROB1
    ,DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) ,2 ,G1.PROVEEDORES, NULL) APROB2
    ,DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) ,3 ,G1.PROVEEDORES, NULL) APROB3
    ,DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) ,4 ,G1.PROVEEDORES, NULL) APROB4
    ,DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) ,5 ,G1.PROVEEDORES, NULL) APROB5

    ,DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) ,1 ,G1.FECHA_CREACION, NULL) FECHA_1
    ,DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) ,2 ,G1.FECHA_CREACION, NULL) FECHA_2
    ,DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) ,3 ,G1.FECHA_CREACION, NULL) FECHA_3
    ,DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) ,4 ,G1.FECHA_CREACION, NULL) FECHA_4
    ,DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) ,5 ,G1.FECHA_CREACION, NULL) FECHA_5

    ,G1.MONEDA
      
    --TOTALES
    ,G1.TOTAL_TODO
    ,G1.OrderedDisplay
    ,G1.TotalTaxDisplay
      
    --IDENTIFICADORES
    ,G1.PO_HEADER_ID

FROM(
SELECT DISTINCT
      PHA.SEGMENT1 NUM_OC_1
      ,WF.ASSIGNEESDISPLAYNAME PROVEEDORES
      ,TO_CHAR('PENDIENTE') AS FECHA_CREACION --WF.ASSIGNEDDATE
      ,WF.OUTCOME
      ,WF.STATE
      ,WF.VERSION

----------------------------------------------------
      ,PHA.CURRENCY_CODE MONEDA

      --TOTALES
      ,po_bip_helper.get_formatted_display(REGEXP_REPLACE( PO_BIP_HELPER.get_ordered_display( PHA.PO_HEADER_ID, '0', 'DRAFT', 'H', PHA.CURRENCY_CODE ), ',', '' ) + REGEXP_REPLACE( PO_BIP_HELPER.get_total_tax( PHA.PO_HEADER_ID, 'HEADER' ), ',', '' )
      ) AS TOTAL_TODO
      ,PO_BIP_HELPER.get_ordered_display(PHA.PO_HEADER_ID,'0','TXN','H',PHA.CURRENCY_CODE) AS OrderedDisplay
      ,PO_BIP_HELPER.get_total_tax_arch(PHA.PO_HEADER_ID,'HEADER',PV.CO_SEQUENCE) AS TotalTaxDisplay

      --IDENTIFICADORES
      ,PHA.PO_HEADER_ID
----------------------------------------------------

FROM FUSION.PO_VERSIONS PV
    ,FUSION.PO_HEADERS_ALL PHA
    ,FA_FUSION_SOAINFRA.WFTASK WF

WHERE PV.PO_HEADER_ID = PHA.PO_HEADER_ID
AND PV.APPROVAL_INSTANCE_ID=WF.COMPOSITEINSTANCEID
AND WF.ASSIGNEES IS NOT NULL
--AND PHA.SEGMENT1= 'OCA4768'
--AND PHA.SEGMENT1 = NVL(:P_NUM_OC,PHA.SEGMENT1)
AND WF.WORKFLOWPATTERN NOT IN ('AGGREGATION', 'FYI')
AND WF.COMPONENTNAME='DocumentApproval'
AND PV.CHANGE_ORDER_STATUS = 'PENDING APPROVAL'
AND WF.STATE='ASSIGNED'

--- PRIMERA VERSION
AND PHA.TYPE_LOOKUP_CODE = 'STANDARD'
--- VALIDACIONES DE APROBADORES 
AND PV.ORIGINATOR_ROLE = 'BUYER'
--AND PHA.APPROVED_FLAG = 'Y'     ---NO SE CUMPLE
AND PHA.DOCUMENT_STATUS = 'PENDING APPROVAL' ---NO SE CUMPLE
AND TO_CHAR(PHA.CREATION_DATE,'YYYY-MM-DD') BETWEEN NVL(TO_CHAR(:P_FECHA_INICIAL,'YYYY-MM-DD'),TO_CHAR(PHA.CREATION_DATE,'YYYY-MM-DD')) AND NVL(TO_CHAR(:P_FECHA_FINAL,'YYYY-MM-DD'),TO_CHAR(PHA.CREATION_DATE,'YYYY-MM-DD'))

UNION ALL

SELECT DISTINCT
      PHA.SEGMENT1 NUM_OC_1
      ,WF.ASSIGNEESDISPLAYNAME PROVEEDORES
      ,TO_CHAR(WF.UPDATEDDATE, 'DD-MM-YYYY') FECHA_CREACION
      ,WF.OUTCOME
      ,WF.STATE
      ,WF.VERSION

----------------------------------------------------
      ,PHA.CURRENCY_CODE MONEDA

      --TOTALES
      ,po_bip_helper.get_formatted_display(REGEXP_REPLACE( PO_BIP_HELPER.get_ordered_display( PHA.PO_HEADER_ID, '0', 'DRAFT', 'H', PHA.CURRENCY_CODE ), ',', '' ) + REGEXP_REPLACE( PO_BIP_HELPER.get_total_tax( PHA.PO_HEADER_ID, 'HEADER' ), ',', '' )
      ) AS TOTAL_TODO
      ,PO_BIP_HELPER.get_ordered_display(PHA.PO_HEADER_ID,'0','TXN','H',PHA.CURRENCY_CODE) AS OrderedDisplay
      ,PO_BIP_HELPER.get_total_tax_arch(PHA.PO_HEADER_ID,'HEADER',PV.CO_SEQUENCE) AS TotalTaxDisplay

      --IDENTIFICADORES
      ,PHA.PO_HEADER_ID
----------------------------------------------------

FROM FUSION.PO_VERSIONS PV
    ,FUSION.PO_HEADERS_ALL PHA
    ,FA_FUSION_SOAINFRA.WFTASKHISTORY WF

WHERE PV.PO_HEADER_ID = PHA.PO_HEADER_ID
  AND PV.APPROVAL_INSTANCE_ID = WF.COMPOSITEINSTANCEID
  AND WF.ASSIGNEES IS NOT NULL
  --AND PHA.SEGMENT1= 'OCA4768'
  --AND PHA.SEGMENT1 = NVL(:P_NUM_OC,PHA.SEGMENT1)
  AND WF.WORKFLOWPATTERN NOT IN ('AGGREGATION', 'FYI')
  AND WF.COMPONENTNAME = 'DocumentApproval'
  AND PV.CHANGE_ORDER_STATUS = 'PENDING APPROVAL'
  AND WF.OUTCOME = 'APPROVE'

--- PRIMERA VERSION
AND PHA.TYPE_LOOKUP_CODE = 'STANDARD'
--- VALIDACIONES DE APROBADORES 
AND PV.ORIGINATOR_ROLE = 'BUYER'
--AND PHA.APPROVED_FLAG = 'Y'     ---NO SE CUMPLE
AND PHA.DOCUMENT_STATUS = 'PENDING APPROVAL' ---NO SE CUMPLE
AND TO_CHAR(PHA.CREATION_DATE,'YYYY-MM-DD') BETWEEN NVL(TO_CHAR(:P_FECHA_INICIAL,'YYYY-MM-DD'),TO_CHAR(PHA.CREATION_DATE,'YYYY-MM-DD')) AND NVL(TO_CHAR(:P_FECHA_FINAL,'YYYY-MM-DD'),TO_CHAR(PHA.CREATION_DATE,'YYYY-MM-DD'))

)G1

GROUP BY G1.NUM_OC_1
        ,G1.PROVEEDORES
        ,G1.FECHA_CREACION

        ,G1.MONEDA
          
        --TOTALES
        ,G1.TOTAL_TODO
        ,G1.OrderedDisplay
        ,G1.TotalTaxDisplay
          
        --IDENTIFICADORES
        ,G1.PO_HEADER_ID

ORDER BY G1.NUM_OC_1 ,ROWN ASC
```

## Tablas utilizadas: 

PO_VERSIONS -> PV

PO_HEADERS_ALL -> PHA

WFTASK -> WF

HZ_PARTIES -> HP

## Procedimiento:

Para este Query se necesita agregar la descripción de la OC y el nombre de proveedor los cuales se encuentran en: G1 (La tabla principal formada por todos los campos) y HZ_PARTIES -> HP de la cual sacaremos el nombre del proveedor. 

Para la descripción solamente se buscó coincidencias en la tabla solo se agrega directamente cómo G1.OC_DESCRIPCION.

En el caso de nombre de proveedor se tiene que hacer relación con la tabla HZ_PARTIES -> HP.

En este caso buscamos la posible relación con llaves foráneas la cual será la siguiente: 
LEFT JOIN HZ_PARTIES HP
ON HP.PARTY_ID = G1.VENDOR_ID.

Una vez hecha la relación agregamos el campo que contiene el nombre de cada proveedor y solo mejoramos el diseño.

HP.PARTY_NAME.

### Query modificado: 

``` SQL
SELECT DISTINCT

    G1.NUM_OC_1,

    G1.PROVEEDORES,

    G1.OC_DESCRIPCION,

    G1.VENDOR_ID,

    HP.PARTY_NAME,

    (ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)) AS ROWN,

    DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)), 1, G1.PROVEEDORES, NULL) APROB1,

    DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)), 2, G1.PROVEEDORES, NULL) APROB2,

    DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)), 3, G1.PROVEEDORES, NULL) APROB3,

    DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)), 4, G1.PROVEEDORES, NULL) APROB4,

    DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)), 5, G1.PROVEEDORES, NULL) APROB5,

    DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)), 1, G1.FECHA_CREACION, NULL) FECHA_1,

    DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)), 2, G1.FECHA_CREACION, NULL) FECHA_2,

    DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)), 3, G1.FECHA_CREACION, NULL) FECHA_3,

    DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)), 4, G1.FECHA_CREACION, NULL) FECHA_4,

    DECODE((ROW_NUMBER() OVER(PARTITION BY G1.NUM_OC_1 ORDER BY G1.PROVEEDORES ASC)), 5, G1.FECHA_CREACION, NULL) FECHA_5,

    G1.MONEDA,

    G1.TOTAL_TODO,

    G1.OrderedDisplay,

    G1.TotalTaxDisplay,

    G1.PO_HEADER_ID

FROM (

    SELECT DISTINCT

          PHA.VENDOR_ID,

          PHA.SEGMENT1 NUM_OC_1,

          WF.ASSIGNEESDISPLAYNAME PROVEEDORES,

          TO_CHAR('PENDIENTE') AS FECHA_CREACION,

          WF.OUTCOME,

          WF.STATE,

          WF.VERSION,

          (SELECT MIN(ITEM_DESCRIPTION) FROM FUSION.PO_LINES_ALL PL WHERE PL.PO_HEADER_ID = PHA.PO_HEADER_ID) AS OC_DESCRIPCION,

          PHA.CURRENCY_CODE MONEDA,

          po_bip_helper.get_formatted_display(

              REGEXP_REPLACE(PO_BIP_HELPER.get_ordered_display(PHA.PO_HEADER_ID, '0', 'DRAFT', 'H', PHA.CURRENCY_CODE), ',', '') +

              REGEXP_REPLACE(PO_BIP_HELPER.get_total_tax(PHA.PO_HEADER_ID, 'HEADER'), ',', '')

          ) AS TOTAL_TODO,

          PO_BIP_HELPER.get_ordered_display(PHA.PO_HEADER_ID,'0','TXN','H',PHA.CURRENCY_CODE) AS OrderedDisplay,

          PO_BIP_HELPER.get_total_tax_arch(PHA.PO_HEADER_ID,'HEADER',PV.CO_SEQUENCE) AS TotalTaxDisplay,

          PHA.PO_HEADER_ID

    FROM FUSION.PO_VERSIONS PV,

         FUSION.PO_HEADERS_ALL PHA,

         FA_FUSION_SOAINFRA.WFTASK WF

    WHERE PV.PO_HEADER_ID = PHA.PO_HEADER_ID

      AND PV.APPROVAL_INSTANCE_ID = WF.COMPOSITEINSTANCEID

      AND WF.ASSIGNEES IS NOT NULL

      AND WF.WORKFLOWPATTERN NOT IN ('AGGREGATION', 'FYI')

      AND WF.COMPONENTNAME = 'DocumentApproval'

      AND PV.CHANGE_ORDER_STATUS = 'PENDING APPROVAL'

      AND WF.STATE = 'ASSIGNED'

      AND PHA.TYPE_LOOKUP_CODE = 'STANDARD'

      AND PV.ORIGINATOR_ROLE = 'BUYER'

      AND PHA.DOCUMENT_STATUS = 'PENDING APPROVAL'

      AND TO_CHAR(PHA.CREATION_DATE, 'YYYY-MM-DD') BETWEEN NVL(TO_CHAR(:P_FECHA_INICIAL, 'YYYY-MM-DD'), TO_CHAR(PHA.CREATION_DATE, 'YYYY-MM-DD'))

                                                     AND NVL(TO_CHAR(:P_FECHA_FINAL, 'YYYY-MM-DD'), TO_CHAR(PHA.CREATION_DATE, 'YYYY-MM-DD'))

  

    UNION ALL

  

    SELECT DISTINCT

          PHA.VENDOR_ID,

          PHA.SEGMENT1 NUM_OC_1,

          WF.ASSIGNEESDISPLAYNAME PROVEEDORES,

          TO_CHAR(WF.UPDATEDDATE, 'DD-MM-YYYY') FECHA_CREACION,

          WF.OUTCOME,

          WF.STATE,

          WF.VERSION,

          (SELECT MIN(ITEM_DESCRIPTION) FROM FUSION.PO_LINES_ALL PL WHERE PL.PO_HEADER_ID = PHA.PO_HEADER_ID) AS OC_DESCRIPCION,

          PHA.CURRENCY_CODE MONEDA,

          po_bip_helper.get_formatted_display(

              REGEXP_REPLACE(PO_BIP_HELPER.get_ordered_display(PHA.PO_HEADER_ID, '0', 'DRAFT', 'H', PHA.CURRENCY_CODE), ',', '') +

              REGEXP_REPLACE(PO_BIP_HELPER.get_total_tax(PHA.PO_HEADER_ID, 'HEADER'), ',', '')

          ) AS TOTAL_TODO,

          PO_BIP_HELPER.get_ordered_display(PHA.PO_HEADER_ID,'0','TXN','H',PHA.CURRENCY_CODE) AS OrderedDisplay,

          PO_BIP_HELPER.get_total_tax_arch(PHA.PO_HEADER_ID,'HEADER',PV.CO_SEQUENCE) AS TotalTaxDisplay,

          PHA.PO_HEADER_ID

    FROM FUSION.PO_VERSIONS PV,

         FUSION.PO_HEADERS_ALL PHA,

         FA_FUSION_SOAINFRA.WFTASKHISTORY WF

    WHERE PV.PO_HEADER_ID = PHA.PO_HEADER_ID

      AND PV.APPROVAL_INSTANCE_ID = WF.COMPOSITEINSTANCEID

      AND WF.ASSIGNEES IS NOT NULL

      AND WF.WORKFLOWPATTERN NOT IN ('AGGREGATION', 'FYI')

      AND WF.COMPONENTNAME = 'DocumentApproval'

      AND PV.CHANGE_ORDER_STATUS = 'PENDING APPROVAL'

      AND WF.OUTCOME = 'APPROVE'

      AND PHA.TYPE_LOOKUP_CODE = 'STANDARD'

      AND PV.ORIGINATOR_ROLE = 'BUYER'

      AND PHA.DOCUMENT_STATUS = 'PENDING APPROVAL'

      AND TO_CHAR(PHA.CREATION_DATE, 'YYYY-MM-DD') BETWEEN NVL(TO_CHAR(:P_FECHA_INICIAL, 'YYYY-MM-DD'), TO_CHAR(PHA.CREATION_DATE, 'YYYY-MM-DD'))

                                                     AND NVL(TO_CHAR(:P_FECHA_FINAL, 'YYYY-MM-DD'), TO_CHAR(PHA.CREATION_DATE, 'YYYY-MM-DD'))

) G1

LEFT JOIN HZ_PARTIES HP

    ON HP.PARTY_ID = G1.VENDOR_ID

GROUP BY

    G1.NUM_OC_1,

    G1.PROVEEDORES,

    G1.OC_DESCRIPCION,

    G1.FECHA_CREACION,

    G1.MONEDA,

    G1.TOTAL_TODO,

    G1.OrderedDisplay,

    G1.TotalTaxDisplay,

    G1.PO_HEADER_ID,

    G1.VENDOR_ID,

    HP.PARTY_NAME

ORDER BY G1.NUM_OC_1, ROWN ASC
```





